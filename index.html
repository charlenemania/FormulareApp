<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Formulare Übersicht</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Formulare Übersicht</h1>
  <input type="text" id="search" placeholder="Formular suchen..." onkeyup="searchFormular()">
  <div id="app"></div>

  <script>
    let data = null;
    let lastSearchTerm = "";      // speichert letzten Suchbegriff
    let cameFromSearch = false;   // merkt sich, ob Navigation aus der Suche kam

    fetch('formulare.json')
      .then(response => response.json())
      .then(json => {
        data = json;
        renderDemosysteme();
      });

    function renderDemosysteme() {
      const app = document.getElementById('app');
      app.innerHTML = '';
      cameFromSearch = false;   // bei normaler Navigation zurücksetzen

      data.demosysteme.forEach(ds => {
        const div = document.createElement('div');
        div.className = 'system';

        div.innerHTML = `
          <small style="color:#888; display:block; margin-bottom:4px; font-size:0.75rem;">
            ${ds.url || ""}
          </small>
          ${ds.name}
        `;

        div.onclick = () => renderFormulare(ds);
        app.appendChild(div);
      });
    }

    function renderFormulare(system) {
      const app = document.getElementById('app');
      cameFromSearch = false; // nicht aus Suche

      app.innerHTML = `
        <h2>${system.name}</h2>
        <button onclick="renderDemosysteme()">← Zurück</button>
      `;

      system.formulare.forEach(f => {
        const div = document.createElement('div');
        div.className = 'formular';

        div.innerHTML = `
          <small style="color:#888; display:block; margin-bottom:4px; font-size:0.75rem;">
            ${f.id}
          </small>
          ${f.name}
        `;

        div.onclick = () => {
          cameFromSearch = false;
          renderItems(system, f);
        };

        app.appendChild(div);
      });
    }

    function handleBack(systemId) {
      if (cameFromSearch) {
        // zurück zu den Suchergebnissen
        document.getElementById('search').value = lastSearchTerm;
        searchFormular();
        return;
      }

      const ds = data.demosysteme.find(d => d.id === systemId);
      renderFormulare(ds);
    }

    function renderItems(system, formular) {
      const app = document.getElementById('app');

      app.innerHTML = `
        <h2>${formular.name}</h2>
        <button onclick="handleBack('${system.id}')">← Zurück</button>
      `;

      if (formular.questionnaireFile) {
        fetch(formular.questionnaireFile)
          .then(response => response.json())
          .then(json => {
            const downloadBtn = document.createElement('button');
            downloadBtn.textContent = 'download JSON';
            downloadBtn.style.marginTop = '10px';
            downloadBtn.style.padding = '8px 16px';
            downloadBtn.style.cursor = 'pointer';

            downloadBtn.onclick = () => {
              const filename = formular.questionnaireFile.split('/').pop();
              const blob = new Blob([JSON.stringify(json, null, 2)], { type: 'application/json' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = filename;
              a.click();
              URL.revokeObjectURL(url);
            };

            app.appendChild(downloadBtn);

            const pre = document.createElement('pre');
            const code = document.createElement('code');
            code.textContent = JSON.stringify(json, null, 2);
            pre.appendChild(code);
            app.appendChild(pre);
          })
          .catch(error => {
            app.innerHTML += `<p style="color: red;">Fehler beim Laden: ${error.message}</p>`;
          });

      } else {
        const ul = document.createElement('ul');
        ul.className = 'items';

        formular.items.forEach(item => {
          const li = document.createElement('li');
          li.textContent = item;
          ul.appendChild(li);
        });

        app.appendChild(ul);
      }
    }

    function searchFormular() {
      const term = document.getElementById('search').value.toLowerCase();
      lastSearchTerm = term;    // SUCHBEGRIFF SPEICHERN
      cameFromSearch = false;   // aktuell befinden wir uns in der Suchübersicht

      const app = document.getElementById('app');
      app.innerHTML = '';

      if (!term) {
        cameFromSearch = false;
        return renderDemosysteme();
      }

      data.demosysteme.forEach(ds => {
        ds.formulare.forEach(f => {
          if (
            f.id.toLowerCase().includes(term) ||
            f.name.toLowerCase().includes(term) ||
            f.items.some(i => i.toLowerCase().includes(term))
          ) {
            const div = document.createElement('div');
            div.className = 'formular';

            div.innerHTML = `
              <small style="color:#888; display:block; font-size:0.75rem;">
                ${f.id}
              </small>
              ${f.name} (System: ${ds.name})
            `;

            div.onclick = () => {
              cameFromSearch = true;  // wir kommen aus der Suche!
              renderItems(ds, f);
            };

            app.appendChild(div);
          }
        });
      });
    }
  </script>
</body>
</html>
