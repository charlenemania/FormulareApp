<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Formulare Übersicht</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Container für Suchfeld + X */
    #search-container {
      position: relative;
      width: 300px;
      margin: 0 auto 20px auto;
    }

    #search {
      width: 100%;
      padding-right: 24px;
      box-sizing: border-box;
    }

    #clear-search {
      position: absolute;
      right: 4px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      color: #888;
      display: none;
    }

    #clear-search:hover {
      color: #333;
    }

    /* Suchhighlight */
    mark.search-highlight {
      background-color: rgb(217, 233, 238);
      padding: 0 2px;
      border-radius: 2px;
    }

    /* Download JSON Button */
    button.download-json {
      background-color: rgb(217, 233, 238);
      border: 1px solid #d9e9ee;
      border-radius: 4px;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 1rem;
      margin-top: 10px;
      color: #24292f;
    }

    button.download-json:hover {
      background-color: rgb(198, 223, 230);
    }
  </style>
</head>
<body>
  <h1>Formulare Übersicht</h1>

  <div id="search-container">
    <input type="text" id="search" placeholder="Formular suchen..." onkeyup="searchFormular()">
    <button id="clear-search" onclick="clearSearch()">×</button>
  </div>

  <div id="app"></div>

  <script>
    let data = null;
    let lastSearchTerm = "";
    let cameFromSearch = false;

    fetch('formulare.json')
      .then(response => response.json())
      .then(json => {
        data = json;
        renderDemosysteme();
      });

    function renderDemosysteme() {
      const app = document.getElementById('app');
      app.innerHTML = '';
      cameFromSearch = false;
      toggleClearButton();

      data.demosysteme.forEach(ds => {
        const div = document.createElement('div');
        div.className = 'system';
        div.innerHTML = `
          <small style="color:#888; display:block; margin-bottom:4px; font-size:0.75rem;">
            ${ds.url || ""}
          </small>
          ${ds.name}
        `;
        div.onclick = () => renderFormulare(ds);
        app.appendChild(div);
      });
    }

    function renderFormulare(system) {
      const app = document.getElementById('app');
      cameFromSearch = false;
      toggleClearButton();

      app.innerHTML = `
        <h2>${system.name}</h2>
        <button onclick="renderDemosysteme()">← Zurück</button>
      `;

      system.formulare.forEach(f => {
        const div = document.createElement('div');
        div.className = 'formular';
        div.innerHTML = `
          <small style="color:#888; display:block; margin-bottom:4px; font-size:0.75rem;">
            ${f.id}
          </small>
          ${f.name}
        `;
        div.onclick = () => {
          cameFromSearch = false;
          renderItems(system, f);
        };
        app.appendChild(div);
      });
    }

    function handleBack(systemId) {
      if (cameFromSearch) {
        document.getElementById('search').value = lastSearchTerm;
        searchFormular();
        return;
      }
      const ds = data.demosysteme.find(d => d.id === systemId);
      renderFormulare(ds);
    }

    function renderItems(system, formular) {
      const app = document.getElementById('app');
      app.innerHTML = `
        <h2>${formular.name}</h2>
        <button onclick="handleBack('${system.id}')">← Zurück</button>
      `;

      if (formular.questionnaireFile) {
        fetch(formular.questionnaireFile)
          .then(response => response.json())
          .then(json => {
            const downloadBtn = document.createElement('button');
            downloadBtn.textContent = 'download JSON';
            downloadBtn.className = 'download-json';
            downloadBtn.onclick = () => {
              const filename = formular.questionnaireFile.split('/').pop();
              const blob = new Blob([JSON.stringify(json, null, 2)], { type: 'application/json' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = filename;
              a.click();
              URL.revokeObjectURL(url);
            };
            app.appendChild(downloadBtn);

            const pre = document.createElement('pre');
            const code = document.createElement('code');
            code.textContent = JSON.stringify(json, null, 2);
            pre.appendChild(code);
            app.appendChild(pre);
          })
          .catch(error => {
            app.innerHTML += `<p style="color: red;">Fehler beim Laden: ${error.message}</p>`;
          });
      } else {
        const ul = document.createElement('ul');
        ul.className = 'items';
        formular.items.forEach(item => {
          const li = document.createElement('li');
          li.innerHTML = highlightMatch(item, document.getElementById('search').value);
          ul.appendChild(li);
        });
        app.appendChild(ul);
      }
    }

    function searchFormular() {
      const term = document.getElementById('search').value.toLowerCase();
      lastSearchTerm = term;
      cameFromSearch = false;
      toggleClearButton();

      const app = document.getElementById('app');
      app.innerHTML = '';

      if (!term) return renderDemosysteme();

      data.demosysteme.forEach(ds => {
        ds.formulare.forEach(f => {
          if (
            f.id.toLowerCase().includes(term) ||
            f.name.toLowerCase().includes(term) ||
            f.items.some(i => i.toLowerCase().includes(term))
          ) {
            const div = document.createElement('div');
            div.className = 'formular';

            const highlightedId = highlightMatch(f.id, term);
            const highlightedName = highlightMatch(f.name, term);

            div.innerHTML = `
              <small style="color:#888; display:block; font-size:0.75rem;">
                ${highlightedId}
              </small>
              ${highlightedName} (System: ${ds.name})
            `;

            div.onclick = () => {
              cameFromSearch = true;
              renderItems(ds, f);
            };
            app.appendChild(div);
          }
        });
      });
    }

    function highlightMatch(text, term) {
      if (!term) return text;
      const regex = new RegExp(`(${term})`, 'gi');
      return text.replace(regex, `<mark class="search-highlight">$1</mark>`);
    }

    function clearSearch() {
      document.getElementById('search').value = '';
      lastSearchTerm = '';
      cameFromSearch = false;
      toggleClearButton();
      renderDemosysteme();
    }

    function toggleClearButton() {
      const btn = document.getElementById('clear-search');
      btn.style.display = document.getElementById('search').value ? 'block' : 'none';
    }
  </script>
</body>
</html>
