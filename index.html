<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Formulare Übersicht</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
    }

    .search-container {
      position: relative;
      max-width: 400px;
      margin: 0 auto 20px auto;
    }

    .search-input {
      width: 100%;
      padding: 10px 30px 10px 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }

    .clear-search {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      font-size: 16px;
      cursor: pointer;
      color: #999;
      display: none;
    }

    .demosysteme {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 15px;
    }

    .demosystem-card {
      background-color: #fff;
      border-radius: 6px;
      padding: 15px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: box-shadow 0.2s ease, transform 0.2s ease;
    }

    .demosystem-card:hover {
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
      transform: translateY(-1px);
    }

    .formular {
      background-color: #fff;
      border-radius: 4px;
      padding: 10px 12px;
      margin-bottom: 8px;
      cursor: pointer;
      border: 1px solid #e0e0e0;
      transition: background-color 0.2s ease;
    }

    .formular:hover {
      background-color: #f0f0f0;
    }

    .item-list {
      margin-top: 15px;
    }

    .item {
      background-color: #fff;
      border-radius: 4px;
      padding: 8px 10px;
      margin-bottom: 6px;
      border: 1px solid #e0e0e0;
      font-size: 14px;
    }

    .back-button {
      margin-bottom: 10px;
    }

    .highlight {
      background-color: yellow;
    }

    .section-title {
      font-weight: bold;
      margin-top: 20px;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Formulare Übersicht</h1>

    <div id="search-container" class="search-container">
      <input
        type="text"
        id="search"
        class="search-input"
        placeholder="Formular suchen..."
        onkeyup="searchFormular()"
      >
      <button
        id="clear-search"
        class="clear-search"
        onclick="clearSearch()"
      >×</button>

      <div
        id="search-filters"
        style="max-width:400px;margin:8px auto 0 auto;font-size:0.85rem;"
      >
        <label>
          <input type="checkbox" id="filter-title" checked>
          Formulartitel
        </label>
        <label style="margin-left:12px;">
          <input type="checkbox" id="filter-id" checked>
          Formularname
        </label>
        <label style="margin-left:12px;">
          <input type="checkbox" id="filter-content">
          Formularinhalt
        </label>
      </div>
    </div>

    <div id="app"></div>
  </div>

  <script>
    let data = null;
    let lastSearchTerm = '';
    let cameFromSearch = false;

    function fetchData() {
      fetch('formulare.json')
        .then(response => response.json())
        .then(json => {
          data = json;
          renderDemosysteme();
        });
    }

    function toggleClearButton() {
      const searchInput = document.getElementById('search');
      const clearBtn = document.getElementById('clear-search');
      clearBtn.style.display = searchInput.value ? 'block' : 'none';
    }

    function clearSearch() {
      const searchInput = document.getElementById('search');
      searchInput.value = '';
      lastSearchTerm = '';
      cameFromSearch = false;
      toggleClearButton();
      renderDemosysteme();
    }

    function clearSystemSearch(systemId) {
      const searchInput = document.getElementById('system-search');
      if (searchInput) {
        searchInput.value = '';
      }
      const btn = document.getElementById('clear-system-search');
      if (btn) {
        btn.style.display = 'none';
      }
      const system = data.demosysteme.find(ds => ds.id === systemId);
      if (system) {
        renderFormularListe(system, system.formulare);
      }
    }

    function highlightMatch(text, term) {
      if (!term) return text;
      const lowerText = text.toLowerCase();
      const lowerTerm = term.toLowerCase();
      const index = lowerText.indexOf(lowerTerm);
      if (index === -1) return text;
      return (
        text.substring(0, index) +
        '<span class="highlight">' +
        text.substring(index, index + term.length) +
        '</span>' +
        text.substring(index + term.length)
      );
    }

    function matchesFormular(f, term, options) {
      const t = term.toLowerCase();
      let match = false;

      if (options.byId && f.id && f.id.toLowerCase().includes(t)) match = true;
      if (options.byName && f.name && f.name.toLowerCase().includes(t)) match = true;

      if (options.byContent) {
        if (f.items && f.items.some(i => (i || '').toLowerCase().includes(t))) {
          match = true;
        }
        // Optional: Inhalte aus questionnaireFile durchsuchen, wenn gecacht
      }

      return match;
    }

    function renderDemosysteme() {
      const app = document.getElementById('app');
      app.innerHTML = '';

      const demosystemeDiv = document.createElement('div');
      demosystemeDiv.className = 'demosysteme';

      data.demosysteme.forEach(system => {
        const card = document.createElement('div');
        card.className = 'demosystem-card';
        card.innerHTML = `
          <div class="section-title">${system.name}</div>
          <div>${system.beschreibung || ''}</div>
        `;
        card.onclick = () => renderFormulare(system);
        demosystemeDiv.appendChild(card);
      });

      app.appendChild(demosystemeDiv);
    }

    function renderFormularListe(system, formularArray) {
      const listDiv = document.getElementById('formular-list');
      listDiv.innerHTML = '';

      formularArray.forEach(f => {
        const div = document.createElement('div');
        div.className = 'formular';

        let titleHtml = f.name;
        let idHtml = f.id;

        if (lastSearchTerm) {
          titleHtml = highlightMatch(f.name, lastSearchTerm);
          idHtml = highlightMatch(f.id, lastSearchTerm);
        }

        div.innerHTML = `
          <small style="color:#888; display:block; font-size:0.75rem;">
            ${idHtml}
          </small>
          ${titleHtml}
        `;
        div.onclick = () => {
          cameFromSearch = false;
          renderItems(system, f);
        };
        listDiv.appendChild(div);
      });
    }

    function renderFormulare(system) {
      const app = document.getElementById('app');
      app.innerHTML = `
        <button class="back-button" onclick="renderDemosysteme()">← Zurück zu den Demosystemen</button>
        <h2>${system.name}</h2>
        <div class="section-title">Formulare</div>

        <div id="system-search-container" class="search-container">
          <input
            type="text"
            id="system-search"
            class="search-input"
            placeholder="Formular in ${system.name} suchen..."
            onkeyup="searchFormulareInSystem('${system.id}')"
          >
          <button
            id="clear-system-search"
            class="clear-search"
            onclick="clearSystemSearch('${system.id}')"
          >×</button>
        </div>

        <div
          id="system-search-filters"
          style="max-width:400px;margin:8px auto 0 auto;font-size:0.85rem;"
        >
          <label>
            <input type="checkbox" id="system-filter-title" checked>
            Formulartitel
          </label>
          <label style="margin-left:12px;">
            <input type="checkbox" id="system-filter-id" checked>
            Formularname
          </label>
          <label style="margin-left:12px;">
            <input type="checkbox" id="system-filter-content">
            Formularinhalt
          </label>
        </div>

        <div id="formular-list"></div>
      `;

      renderFormularListe(system, system.formulare);
    }

    function renderItems(system, formular) {
      const app = document.getElementById('app');

      app.innerHTML = `
        <button class="back-button" onclick="renderFormulare('${system.id ? system.id : system}')">← Zurück zu den Formularen</button>
        <h2>${formular.name}</h2>
        <div class="section-title">Formularname (ID)</div>
        <div>${formular.id}</div>
        <div class="section-title">Formulartitel</div>
        <div>${formular.name}</div>
        <div class="section-title">Items</div>
        <div id="item-list" class="item-list"></div>
      `;

      const itemList = document.getElementById('item-list');
      formular.items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'item';
        div.textContent = item;
        itemList.appendChild(div);
      });
    }

    function searchFormular() {
      const term = document.getElementById('search').value.toLowerCase();
      lastSearchTerm = term;
      cameFromSearch = false;
      toggleClearButton();

      const app = document.getElementById('app');
      app.innerHTML = '';
      if (!term) return renderDemosysteme();

      const filterOptions = {
        byName: document.getElementById('filter-title')?.checked ?? true,
        byId: document.getElementById('filter-id')?.checked ?? true,
        byContent: document.getElementById('filter-content')?.checked ?? false
      };

      data.demosysteme.forEach(ds => {
        ds.formulare.forEach(f => {
          if (matchesFormular(f, term, filterOptions)) {
            const div = document.createElement('div');
            div.className = 'formular';
            const highlightedId = highlightMatch(f.id, term);
            const highlightedName = highlightMatch(f.name, term);
            div.innerHTML = `
              <small style="color:#888; display:block; font-size:0.75rem;">
                ${highlightedId}
              </small>
              ${highlightedName}
              <span style="font-size:0.85rem; font-style:italic; color:#555;">
                (System: ${ds.name})
              </span>
            `;
            div.onclick = () => {
              cameFromSearch = true;
              renderItems(ds, f);
            };
            app.appendChild(div);
          }
        });
      });
    }

    function searchFormulareInSystem(systemId) {
      const term = document.getElementById('system-search').value.toLowerCase();
      const system = data.demosysteme.find(ds => ds.id === systemId);
      if (!system) return;

      const filterOptions = {
        byName: document.getElementById('system-filter-title')?.checked ?? true,
        byId: document.getElementById('system-filter-id')?.checked ?? true,
        byContent: document.getElementById('system-filter-content')?.checked ?? false
      };

      const filtered = system.formulare.filter(f => matchesFormular(f, term, filterOptions));
      renderFormularListe(system, filtered);

      const btn = document.getElementById('clear-system-search');
      btn.style.display = term ? 'block' : 'none';
    }

    window.onload = fetchData;
  </script>
</body>
</html>
